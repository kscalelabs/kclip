<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extract Metadata and File from MKV</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
</head>
<body>
  <h1>Extract Metadata and File from MKV</h1>
  <input type="file" id="uploader" accept=".mkv" />
  <pre id="output"></pre>
  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const initFFmpeg = async () => {
      const output = document.getElementById('output');
      output.textContent = 'Loading ffmpeg.wasm...';
      await ffmpeg.load();
      output.textContent = 'ffmpeg.wasm loaded. Ready to process files.';
    };

    const extractMetadata = (logs) => {
      const metadata = {};
      const lines = logs ? logs.split('\n') : [];

      for (const line of lines) {
        if (line.includes('title')) {
          metadata.title = line.split(':')[1]?.trim();
        } else if (line.includes('UUID')) {
          metadata.uuid = line.split(':')[1]?.trim();
        } else if (line.includes('ACTION')) {
          metadata.action = line.split(':')[1]?.trim();
        }
      }
      return metadata;
    };

    const handleFileUpload = async (event) => {
      const output = document.getElementById('output');
      const file = event.target.files[0];

      if (file) {
        try {
          output.textContent = `Processing file: ${file.name}...\n`;
          const data = await fetchFile(file);

          // Write the MKV file to ffmpeg.wasm's virtual filesystem
          ffmpeg.FS('writeFile', 'input.mkv', data);

          // Capture logs for metadata
          const logs = [];
          ffmpeg.setLogger(({ message }) => logs.push(message));
          await ffmpeg.run('-i', 'input.mkv');

          // Extract metadata from logs
          const metadata = extractMetadata(logs.join('\n'));

          // Extract the file (test.txt) attachment
          await ffmpeg.run('-dump_attachment:t:0', 'test.txt', '-i', 'input.mkv');

          // Read the extracted file
          const attachment = ffmpeg.FS('readFile', 'test.txt');
          const fileContent = new TextDecoder().decode(attachment);

          // Display metadata and file content
          output.textContent += `Metadata extracted:\nTitle: ${metadata.title || 'N/A'}\nUUID: ${metadata.uuid || 'N/A'}\nACTION: ${metadata.action || 'N/A'}\n\nExtracted File Content:\n${fileContent}`;
        } catch (error) {
          console.error('Error processing file:', error);
          output.textContent = 'Error processing the file. Check the console for details.';
        }
      } else {
        output.textContent = 'No file selected. Please select an MKV file.';
      }
    };

    initFFmpeg();

    document.getElementById('uploader').addEventListener('change', handleFileUpload);
  </script>
</body>
</html>

